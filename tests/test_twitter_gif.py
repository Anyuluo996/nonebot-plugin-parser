"""
æµ‹è¯•æ¨ç‰¹ GIF è½¬æ¢åŠŸèƒ½

æµ‹è¯•é“¾æ¥ï¼š
- GIF: https://x.com/i/status/2017344867878248543
- è§†é¢‘: https://x.com/i/status/2017206656862658581

æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºè„šæœ¬ï¼Œå®é™…ä½¿ç”¨éœ€è¦åœ¨ NoneBot2 æœºå™¨äººä¸­ä½¿ç”¨ã€‚
"""

import asyncio
import tempfile
from pathlib import Path


async def demo_ffprobe():
    """æ¼”ç¤º ffprobe æ£€æµ‹éŸ³é¢‘æµåŠŸèƒ½"""
    print("=" * 60)
    print("æ¼”ç¤º 1: ffprobe æ£€æµ‹éŸ³é¢‘æµ")
    print("=" * 60)

    # ä» utils æ¨¡å—å¯¼å…¥å‡½æ•°
    import sys
    sys.path.insert(0, str(Path(__file__).parent / "src"))

    # æ¨¡æ‹Ÿæ£€æµ‹ç»“æœ
    test_cases = [
        ("video_with_audio.mp4", True, "æœ‰éŸ³é¢‘æµï¼ˆæ™®é€šè§†é¢‘ï¼‰"),
        ("video_no_audio.mp4", False, "æ— éŸ³é¢‘æµï¼ˆGIF è§†é¢‘ï¼‰"),
        ("gif_video.mp4", False, "æ— éŸ³é¢‘æµï¼ˆGIF è§†é¢‘ï¼‰"),
    ]

    for filename, has_audio, description in test_cases:
        status = "ğŸ”Š" if has_audio else "ğŸ”‡"
        print(f"{status} {filename:25s} - {description}")

    print("\nè¯´æ˜:")
    print("  - æœ‰éŸ³é¢‘æµï¼šè¿™æ˜¯æ™®é€šè§†é¢‘ï¼Œä¸è½¬æ¢ä¸º GIF")
    print("  - æ— éŸ³é¢‘æµï¼šè¿™æ˜¯ GIF è§†é¢‘ï¼Œå°†è½¬æ¢ä¸º GIF æ ¼å¼")


async def demo_gif_conversion():
    """æ¼”ç¤º GIF è½¬æ¢æµç¨‹"""
    print("\n" + "=" * 60)
    print("æ¼”ç¤º 2: GIF è½¬æ¢æµç¨‹ï¼ˆä½¿ç”¨ palettegen æ»¤é•œï¼‰")
    print("=" * 60)

    print("\nç¬¬ 1 æ­¥ï¼šç”Ÿæˆè°ƒè‰²æ¿ (palettegen)")
    print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚ ffmpeg -i input.mp4                        â”‚")
    print("â”‚   -vf fps=15,scale=480:-1:flags=lanczos,   â”‚")
    print("â”‚        palettegen                           â”‚")
    print("â”‚   palette.png                               â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nç¬¬ 2 æ­¥ï¼šä½¿ç”¨è°ƒè‰²æ¿ç”Ÿæˆ GIF (paletteuse)")
    print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚ ffmpeg -i input.mp4 -i palette.png          â”‚")
    print("â”‚   -lavfi fps=15,scale=480:-1:flags=lanczos, â”‚")
    print("â”‚          [x];[x][1:v]paletteuse             â”‚")
    print("â”‚   output.gif                                â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nç¬¬ 3 æ­¥ï¼šä½¿ç”¨ gifsicle ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰")
    print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚ gifsicle -O3 --lossy=30 --colors=256        â”‚")
    print("â”‚   -o output_opt.gif output.gif              â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nè½¬æ¢å‚æ•°è¯´æ˜:")
    print("  - fps=15: è¾“å‡º GIF å¸§ç‡ï¼ˆé™ä½å¸§ç‡å¯å‡å°æ–‡ä»¶å¤§å°ï¼‰")
    print("  - scale=480:-1: å®½åº¦ 480pxï¼Œé«˜åº¦è‡ªåŠ¨è®¡ç®—")
    print("  - flags=lanczos: ä½¿ç”¨ Lanczos ç®—æ³•è¿›è¡Œé«˜è´¨é‡ç¼©æ”¾")
    print("  - palettegen: ç”Ÿæˆè‡ªå®šä¹‰è°ƒè‰²æ¿")
    print("  - paletteuse: ä½¿ç”¨è‡ªå®šä¹‰è°ƒè‰²æ¿åº”ç”¨é¢œè‰²")
    print("  - --lossy=30: æœ‰æŸå‹ç¼©ï¼ŒæŸå¤± 30% è´¨é‡ï¼ˆå¯é€‰ï¼‰")


async def demo_twitter_parsing():
    """æ¼”ç¤ºæ¨ç‰¹è§£ææµç¨‹"""
    print("\n" + "=" * 60)
    print("æ¼”ç¤º 3: æ¨ç‰¹è§£ææµç¨‹")
    print("=" * 60)

    print("\næ–¹æ¡ˆ 1ï¼šè§£æ JSON ä¸­çš„ type å­—æ®µï¼ˆé¦–é€‰ï¼‰")
    print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚ 1. æ£€æŸ¥ HTML ä¸­çš„ <script type='application/json'> æ ‡ç­¾")
    print("â”‚ 2. æœç´¢ '\"type\":\"animated_gif\"' å­—ç¬¦ä¸²")
    print("â”‚ 3. å¦‚æœæ‰¾åˆ°ï¼Œæ ‡è®°ä¸º GIFï¼Œä¸‹è½½åè½¬æ¢")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\næ–¹æ¡ˆ 2ï¼šä¸‹è½½åä½¿ç”¨ ffprobe æ£€æµ‹ï¼ˆå¤‡é€‰ï¼‰")
    print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚ 1. ä¸‹è½½è§†é¢‘æ–‡ä»¶")
    print("â”‚ 2. ä½¿ç”¨ ffprobe æ£€æµ‹æ˜¯å¦æœ‰éŸ³é¢‘æµ")
    print("â”‚ 3. æ— éŸ³é¢‘æµ â†’ è½¬æ¢ä¸º GIF")
    print("â”‚ 4. æœ‰éŸ³é¢‘æµ â†’ ä¿æŒåŸè§†é¢‘æ ¼å¼")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nå½“å‰å®ç°ï¼š")
    print("  âœ… ä¸¤ç§æ–¹æ¡ˆéƒ½æ”¯æŒ")
    print("  âœ… ä¼˜å…ˆä½¿ç”¨ JSON type å­—æ®µæ£€æµ‹")
    print("  âœ… è‡ªåŠ¨å›é€€åˆ° ffprobe æ£€æµ‹")


async def demo_config():
    """æ¼”ç¤ºé…ç½®è¯´æ˜"""
    print("\n" + "=" * 60)
    print("æ¼”ç¤º 4: é…ç½®è¯´æ˜")
    print("=" * 60)

    print("\nä»£ç†é…ç½®ï¼ˆå¯é€‰ï¼‰ï¼š")
    print("â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("â”‚ # .env æ–‡ä»¶                                  â”‚")
    print("â”‚ parser_proxy=http://localhost:17890         â”‚")
    print("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nffmpeg/ffprobe è¦æ±‚ï¼š")
    print("  - ffmpeg å¿…é¡»å®‰è£…å¹¶åœ¨ PATH ä¸­")
    print("  - ffprobe å¿…é¡»å®‰è£…å¹¶åœ¨ PATH ä¸­")
    print("  - gifsicle å¯é€‰ï¼ˆç”¨äºè¿›ä¸€æ­¥ä¼˜åŒ– GIFï¼‰")

    print("\nå®‰è£…å‘½ä»¤ï¼š")
    print("  Windows: choco install ffmpeg gifsicle")
    print("  Linux:   sudo apt install ffmpeg gifsicle")
    print("  macOS:   brew install ffmpeg gifsicle")


async def demo_usage():
    """æ¼”ç¤ºä½¿ç”¨æ–¹æ³•"""
    print("\n" + "=" * 60)
    print("æ¼”ç¤º 5: ä½¿ç”¨æ–¹æ³•")
    print("=" * 60)

    print("\nåœ¨ç¾¤èŠä¸­å‘é€æ¨ç‰¹é“¾æ¥ï¼š")
    print("  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”")
    print("  â”‚ https://x.com/i/status/2017344867878248543  â”‚")
    print("  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")

    print("\nå¤„ç†æµç¨‹ï¼š")
    print("  1. æœºå™¨äººè¯†åˆ«æ¨ç‰¹é“¾æ¥")
    print("  2. è°ƒç”¨ xdown.app API è·å–ä¿¡æ¯")
    print("  3. æ£€æµ‹æ˜¯å¦ä¸º GIFï¼ˆJSON type æˆ– ffprobeï¼‰")
    print("  4. ä¸‹è½½è§†é¢‘æ–‡ä»¶")
    print("  5. å¦‚æœæ˜¯ GIFï¼Œè½¬æ¢ä¸º .gif æ ¼å¼")
    print("  6. å‘é€è½¬æ¢åçš„ GIF ç»™ç”¨æˆ·")

    print("\næµ‹è¯•é“¾æ¥ï¼š")
    print("  GIF: https://x.com/i/status/2017344867878248543")
    print("  è§†é¢‘: https://x.com/i/status/2017206656862658581")


async def main():
    """ä¸»å‡½æ•°"""
    print("\n")
    print("â•”" + "=" * 58 + "â•—")
    print("â•‘" + " " * 18 + "æ¨ç‰¹ GIF è½¬æ¢åŠŸèƒ½æ¼”ç¤º" + " " * 18 + "â•‘")
    print("â•š" + "=" * 58 + "â•")

    await demo_ffprobe()
    await demo_gif_conversion()
    await demo_twitter_parsing()
    await demo_config()
    await demo_usage()

    print("\n" + "=" * 60)
    print("åŠŸèƒ½ç‰¹ç‚¹")
    print("=" * 60)
    print("""
âœ… è‡ªåŠ¨æ£€æµ‹ GIF å†…å®¹ï¼ˆJSON type å­—æ®µä¼˜å…ˆï¼‰
âœ… ä½¿ç”¨ palettegen æ»¤é•œç”Ÿæˆé«˜è´¨é‡ GIF
âœ… å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨ ffprobe æ£€æµ‹éŸ³é¢‘æµ
âœ… æ”¯æŒä»£ç†é…ç½®
âœ… å¯é€‰çš„ gifsicle ä¼˜åŒ–
âœ… å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡æœºå™¨äºº
""")

    print("=" * 60)
    print("æ³¨æ„äº‹é¡¹")
    print("=" * 60)
    print("""
âš ï¸  ffmpeg å’Œ ffprobe å¿…é¡»å®‰è£…å¹¶åœ¨ PATH ä¸­
âš ï¸  GIF è½¬æ¢éœ€è¦ä¸€å®šæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…
âš ï¸  è½¬æ¢åçš„ GIF æ–‡ä»¶å¯èƒ½æ¯”åŸå§‹è§†é¢‘å¤§
âš ï¸  å»ºè®®ä½¿ç”¨ä»£ç†è®¿é—®æ¨ç‰¹ API
âš ï¸  gifsicle æ˜¯å¯é€‰çš„ï¼Œä½†æ¨èå®‰è£…
""")


if __name__ == "__main__":
    asyncio.run(main())
